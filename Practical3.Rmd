---
title: "Kaminda - Practical 3"
output: html_notebook
---

```{r}
install.packages("gridExtra")
install.packages("jpeg")
install.packages("imager")
install.packages("magick")

BiocManager::install("EBImage")
install.packages("abind")

install.packages("torch")
install.packages("torchvision")
install.packages("luz")
```

```{r}
library(ggplot2)
library(gridExtra)
library(imager)
```

```{r}
library(jpeg)
library(magick)
```

```{r}
library(EBImage)
```

```{r}
library(grid)
```

```{r}
library(dplyr)
```

```{r}
library(abind)
```


###Exploring the dataset

**0**
# Pneumonia is an infection causing inflammation of the alveoli.
# The benefit of being able to identify it from X-rays is that it provides quick diagnosis, in a safe and non-invasive manner.

```{r}
data_folder = "Data/lab3_chest_xray"
files <-list.files(data_folder, full.names = TRUE, recursive = TRUE )
sort(sample(files, 20))
```
**1**
# These file names tell us that pneumonia can be caused by bacteria or virus.
# This might make predicting pneumonia more difficult because X-rays do not detect microorganisms such as bacteria or viruses. Predicting may not be accurate to produce a result that lets us know the cause of pneumonia.

```{r exploring data}
base_dir <- "Data/lab3_chest_xray"

train_pneumonia_dir <- file.path(base_dir, "train", "PNEUMONIA")
train_normal_dir <- file.path(base_dir, "train", "NORMAL")

test_pneumonia_dir <- file.path(base_dir, "test", "PNEUMONIA")
test_normal_dir <- file.path(base_dir, "test", "NORMAL")

val_normal_dir <- file.path(base_dir, "validate", "NORMAL")
val_pneumonia_dir <- file.path(base_dir, "validate", "PNEUMONIA")

train_pn <- list.files(train_pneumonia_dir, full.names = TRUE)
train_normal <- list.files(train_normal_dir, full.names = TRUE)

test_normal <- list.files(test_normal_dir, full.names = TRUE)
test_pn <- list.files(test_pneumonia_dir, full.names = TRUE)

val_pn <- list.files(val_pneumonia_dir, full.names = TRUE)
val_normal <- list.files(val_normal_dir, full.names = TRUE)

cat("Total images:", length(c(train_pn, train_normal, test_normal, test_pn, val_pn, val_normal)), "\n")
```

```{r}
cat("Total pneumonia images:", length(c(train_pn, test_pn, val_pn)), "\n")
```

```{r}
cat("Total Normal images:", length(c(train_normal, test_normal, val_normal)), "\n")
```

###Creating training datasets

```{r training datasets}
train_dataset <- c(train_pn, train_normal)
train_labels <- c(rep("pneumonia", length(train_pn)), rep("normal", length(train_normal)))

test_dataset <- c(test_pn, test_normal)
test_labels <- c(rep("pneumonia", length(test_pn)), rep("normal", length(test_normal)))

val_dataset <- c(val_pn, val_normal)
val_labels <- c(rep("pneumonia", length(val_pn)), rep("normal", length(val_normal)))

#Creating data frames
train_data <- data.frame(dataset = train_dataset, label = train_labels)
test_data <- data.frame(dataset = test_dataset, label = test_labels)
val_data <- data.frame(dataset = val_dataset, label = val_labels)

#Shuffling the data frame
train_data <- train_data[sample(nrow(train_data)), ]
test_data <- test_data[sample(nrow(test_data)), ]
val_data <- val_data[sample(nrow(val_data)), ]

#Extracting shuffled dataset and labels
shuffled_train_dataset <- train_data$dataset
shuffled_train_labels <- train_data$label

shuffled_test_dataset <- test_data$dataset
shuffled_test_labels <- test_data$label

shuffled_val_dataset <- val_data$dataset
shuffled_val_labels <- val_data$label
```

```{r}
cat("file name: ", shuffled_train_dataset[5], "\nlabel: ", shuffled_train_labels[5])
```

###Data visualization

```{r data visualization}

#  List to store the ggplot objects
plots <- list()

# Iterating through the images and labels
for (i in 1:4) {
  
image <- readImage(shuffled_train_dataset[i])
  
# Creating a ggplot object for the image with the corresponding label
  plot <- ggplot() +
    theme_void() +
    annotation_custom(
      rasterGrob(image, interpolate = TRUE),
      xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf
    )
  
# Adding ggplot object to the list
  plots[[i]] <- plot
}

# Arranging plots in a 2x2 grid
grid.arrange(grobs = plots, nrow = 2, ncol = 2)

```
**2**
# From looking at these images, we need to normalize the image size (i.e. dimensions) before training a model. We may also need to normalize the alignment of images.

###Data pre-processing

```{r}
process_images <- function(shuffled_dataset) {
  
img_size <- 224  # Desired image size
  
# Initializing an empty list to store processed images
X <- list()
  
# Looping through each image path in shuffled_train_dataset
for (image_path in shuffled_dataset) {

# Reading the image
img <- imager::load.image(image_path)
    
# Normalizing the image
img_normalized <- img/255
    
# Resizing the image
img_resized <- resize(img_normalized, img_size, img_size)
    
# Appending the processed image to the list
    X <- c(X, list(img_resized))
  }
  
  return(X)
}
```

```{r training, testing, validating}
train_X <- process_images(shuffled_train_dataset)
test_X <- process_images(shuffled_test_dataset)
val_X <- process_images(shuffled_val_dataset)

train_y <- ifelse(shuffled_train_labels == "normal", 1, 2)
test_y <- ifelse(shuffled_test_labels == "normal", 1, 2)
val_y <- ifelse(shuffled_val_labels == "normal", 1, 2)

train_y <- as.integer(train_y)
test_y <- as.integer(test_y)
val_y <- as.integer(val_y)
```

```{r}
# Creating list to store the ggplot objects
plots <- list()

# Iterating through the images and labels
for (i in 1:4) {
  if (train_y[i] == 0) {
    label <- "Normal"
  } else {
    label <- "Pneumonia"
  }
  
# Creating a ggplot object for the image with the corresponding label
  plot <- ggplot() +
    theme_void() +
    ggtitle(label) +
    annotation_custom(
      rasterGrob(train_X[[i]], interpolate = TRUE),
      xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf
    )
  
# Adding the ggplot object to the list
  plots[[i]] <- plot
}

# Arranging the plots in a 2x2 grid
grid.arrange(grobs = plots, nrow = 2, ncol = 2)
```

```{r}
# Combining train, test, and val vectors into a single data frame
df <- data.frame(
  Data = rep(c("Train", "Test", "Val"), times = c(length(train_y), length(test_y), length(val_y))),
  Value = c(train_y, test_y, val_y)
)

# Creating a single bar plot with facets
fig <- ggplot(df, aes(x = Value)) +
  geom_bar() +
  ylim(0, 510) +
  facet_wrap(~Data, ncol = 3)

# Arranging the plot
grid.arrange(fig, nrow = 1)
```

